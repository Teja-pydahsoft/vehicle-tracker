<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Gate Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-microchip"></i>
            <span>SMART GATE</span>
        </div>
        <nav>
            <a href="#" id="nav-dashboard" class="active" onclick="switchTab('dashboard')"><i class="fas fa-grid-2"></i>
                Dashboard</a>
            <a href="#" id="nav-history" onclick="switchTab('reports')"><i class="fas fa-history"></i> History</a>
            <a href="#"><i class="fas fa-video"></i> Cameras</a>
            <a href="#"><i class="fas fa-cog"></i> Settings</a>
        </nav>
    </div>

    <main class="content">
        <header>
            <h1 id="page-title">Security Overview</h1>
            <div class="user-profile">
                <span id="server-status" class="status-online">Server Online</span>
                <i class="fas fa-bell"></i>
                <div class="avatar">Admin</div>
            </div>
        </header>

        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="switchTab('reports')">Reports & History</button>
        </div>

        <div id="dashboard-view">
            <section class="stats-cards">
                <div class="card card-in">
                    <div class="card-info">
                        <h3>TOTAL IN</h3>
                        <p id="total-in">0</p>
                    </div>
                    <div class="card-icon">
                        <i class="fas fa-arrow-right-to-bracket"></i>
                    </div>
                </div>
                <div class="card card-out">
                    <div class="card-info">
                        <h3>TOTAL OUT</h3>
                        <p id="total-out">0</p>
                    </div>
                    <div class="card-icon">
                        <i class="fas fa-arrow-right-from-bracket"></i>
                    </div>
                </div>
            </section>
        </div>

        <div id="reports-view" style="display: none;">
            <section class="filters-container" style="display: block;">
                <div class="filters-grid">
                    <div class="filter-item">
                        <label>Vehicle Type</label>
                        <select id="filter-type">
                            <option value="All">All Vehicles</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>License Plate</label>
                        <input type="text" id="filter-plate" placeholder="Ex: TS 10...">
                    </div>
                    <div class="filter-item">
                        <label>Start Date</label>
                        <input type="date" id="filter-start-date">
                    </div>
                    <div class="filter-item">
                        <label>End Date</label>
                        <input type="date" id="filter-end-date">
                    </div>
                    <button class="apply-btn" onclick="fetchLogs()">Search History</button>
                </div>
            </section>
        </div>

        <section class="logs-section">
            <div class="section-header">
                <h2 id="table-title">Recent Activity</h2>
                <button onclick="refreshData()"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
            <div class="table-container glass">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Vehicle Type</th>
                            <th>Plate Number</th>
                            <th>Direction</th>
                            <th>Timestamp</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody id="log-table-body">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const API_BASE = window.location.origin;
        let currentTab = 'dashboard';

        // Set default dates
        document.getElementById('filter-start-date').valueAsDate = new Date();
        document.getElementById('filter-end-date').valueAsDate = new Date();

        function switchTab(tab) {
            currentTab = tab;

            // Update Sidebar UI
            document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');

            if (tab === 'dashboard') {
                document.getElementById('nav-dashboard').classList.add('active');
                document.getElementById('dashboard-view').style.display = 'block';
                document.getElementById('reports-view').style.display = 'none';
                document.getElementById('page-title').innerText = "Security Overview";
                document.getElementById('table-title').innerText = "Recent Activity";
                fetchData();
            } else {
                document.getElementById('nav-history').classList.add('active');
                document.getElementById('dashboard-view').style.display = 'none';
                document.getElementById('reports-view').style.display = 'block';
                document.getElementById('page-title').innerText = "Access History";
                document.getElementById('table-title').innerText = "Filtered Results";
                fetchVehicleTypes();
                fetchLogs();
            }
        }

        async function fetchVehicleTypes() {
            try {
                const res = await fetch(`${API_BASE}/vehicle-types`);
                const types = await res.json();
                const select = document.getElementById('filter-type');

                // Keep "All" and add dynamic ones
                select.innerHTML = '<option value="All">All Vehicles</option>';
                types.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.innerText = t.charAt(0).toUpperCase() + t.slice(1);
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error("Error fetching types:", err);
            }
        }

        async function fetchData() {
            if (currentTab !== 'dashboard') return;
            try {
                // Fetch Stats
                const statsRes = await fetch(`${API_BASE}/stats`);
                const stats = await statsRes.json();

                let inCount = 0;
                let outCount = 0;

                stats.summary.forEach(item => {
                    if (item.direction === "IN") inCount = item.count;
                    if (item.direction === "OUT") outCount = item.count;
                });

                document.getElementById('total-in').innerText = inCount;
                document.getElementById('total-out').innerText = outCount;

                // Fetch Recent Logs
                const logsRes = await fetch(`${API_BASE}/logs?limit=10`);
                const logs = await logsRes.json();
                renderTable(logs);

                document.getElementById('server-status').innerText = "Server Online";
                document.getElementById('server-status').className = "status-online";
            } catch (err) {
                handleError(err);
            }
        }

        async function fetchLogs() {
            const vType = document.getElementById('filter-type').value;
            const plate = document.getElementById('filter-plate').value;
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;

            try {
                const url = new URL(`${API_BASE}/logs`);
                url.searchParams.append('vehicle_type', vType);
                if (plate) url.searchParams.append('plate_number', plate);
                if (startDate) url.searchParams.append('start_date', startDate);
                if (endDate) url.searchParams.append('end_date', endDate);
                url.searchParams.append('limit', 100);

                const res = await fetch(url);
                const logs = await res.json();
                renderTable(logs);
            } catch (err) {
                handleError(err);
            }
        }

        function refreshData() {
            if (currentTab === 'dashboard') fetchData();
            else fetchLogs();
        }

        function renderTable(logs) {
            const tableBody = document.getElementById('log-table-body');
            tableBody.innerHTML = "";

            logs.forEach(log => {
                const row = document.createElement('tr');
                const dirClass = log.direction === "IN" ? "status-in" : "status-out";

                // Format time with AM/PM
                let displayTime = log.timestamp;
                try {
                    const dt = new Date(log.timestamp.replace(' ', 'T'));
                    if (!isNaN(dt)) {
                        displayTime = dt.toLocaleString('en-US', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: true
                        }).replace(',', '');
                    }
                } catch (e) { }

                // New Order: ID, Type, Plate, Direction, Time, Confidence
                row.innerHTML = `
                    <td>#${log.track_id}</td>
                    <td style="text-transform: capitalize;">${log.vehicle_type}</td>
                    <td><span class="plate-badge">${log.plate_number || 'N/A'}</span></td>
                    <td><span class="badge ${dirClass}">${log.direction}</span></td>
                    <td>${displayTime}</td>
                    <td>${(log.confidence * 100).toFixed(1)}%</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function handleError(err) {
            console.error("Fetch error:", err);
            document.getElementById('server-status').innerText = "Server Offline";
            document.getElementById('server-status').className = "status-offline";
        }

        // Auto-refresh for dashboard only
        setInterval(() => {
            if (currentTab === 'dashboard') fetchData();
        }, 5000);

        fetchData();
        fetchVehicleTypes();
    </script>
</body>

</html>